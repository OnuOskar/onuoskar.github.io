<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Yuri Manga Grid</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 1rem;
    background: #f8f9fa;
    color: #222;
  }
  #controls {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  #counter {
    font-weight: bold;
  }
  #titleSwitchLabel {
    cursor: pointer;
    user-select: none;
  }
  #container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    max-width: 100vw;
    overflow-x: hidden;
  }
  .year-group {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
  }
  .year-title {
    font-size: 1.2rem;
    font-weight: bold;
    min-width: 3.5rem;
    padding-top: 0.5rem;
  }
  .grid {
    display: grid;
    grid-template-columns: repeat(16, 1fr);
    gap: 0.5rem;
    flex-grow: 1;
  }
  .manga-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    user-select: none;
    aspect-ratio: 1 / 1;
    padding: 0.5rem;
    box-sizing: border-box;
    transition: background-color 0.2s ease;
    overflow: hidden;
    text-align: center;
  }

  .manga-card.read {
    background: #008639;
  }

  .manga-cover {
    width: 100%;
    height: auto;
    object-fit: cover;
    border-radius: 6px;
    aspect-ratio: 1 / 1;
  }

  .title-romaji, .title-native {
    font-size: 0.8rem;
    line-height: 1.1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 100%;
  }

  .title-romaji {
    font-weight: bold;
    margin-bottom: 0.25rem;
  }

  .title-native {
    font-style: italic;
    color: #555;
    margin-top: 0.25rem;
  }

  .cover-link {
    width: 100%;
    display: block;
  }

  a {
    text-decoration: none;
    color: inherit;
  }
  button#downloadBtn {
    padding: 0.4rem 1rem;
    font-size: 1rem;
    border: none;
    background-color: #3182ce;
    color: white;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  button#downloadBtn:hover {
    background-color: #2c5282;
  }
</style>
</head>
<body>

<div id="controls">
  <div id="counter">Loading manga...</div>
   <label id="titleSwitchLabel">
    <input type="checkbox" id="titleSwitch" />
    The site breaks without this button
   </label>
  <button id="downloadBtn">Download Results as Image</button>
</div>

<div id="container"></div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
const container = document.getElementById('container');
const counterEl = document.getElementById('counter');
const titleSwitch = document.getElementById('titleSwitch');
const downloadBtn = document.getElementById('downloadBtn');

let readSet = new Set(JSON.parse(localStorage.getItem('readManga') || "[]"));
let totalMangaCount = 0;

function updateCounter() {
  counterEl.textContent = `User has read ${readSet.size} / ${totalMangaCount} manga`;
}

function createMangaCard(manga) {
  const card = document.createElement('div');
  card.className = 'manga-card';
  if (readSet.has(manga.id)) card.classList.add('read');

  // Toggle read/unread on full card click (including image)
  card.addEventListener('click', (e) => {
    if (e.ctrlKey || e.metaKey || e.button === 1) return; // allow ctrl/middle click to open link
    e.preventDefault();
    if (readSet.has(manga.id)) {
      readSet.delete(manga.id);
      card.classList.remove('read');
    } else {
      readSet.add(manga.id);
      card.classList.add('read');
    }
    localStorage.setItem('readManga', JSON.stringify([...readSet]));
    updateCounter();
  });

  const romaji = document.createElement('div');
  romaji.className = 'title-romaji';
  romaji.textContent = manga.romajiTitle;

  const img = document.createElement('img');
  img.src = manga.coverImage;
  img.alt = manga.romajiTitle;
  img.className = 'manga-cover';
  img.crossOrigin = "anonymous";

  const native = document.createElement('div');
  native.className = 'title-native';
  native.textContent = manga.nativeTitle;

  const link = document.createElement('a');
  link.href = manga.siteUrl;
  link.target = "_blank";
  link.rel = "noopener noreferrer";
  link.className = 'cover-link';
  link.addEventListener('click', (e) => {
    if (!(e.ctrlKey || e.metaKey || e.button === 1)) {
      // prevent redirect unless ctrl/meta/middle-click
      e.preventDefault();
    }
  });
  link.appendChild(img);

  card.appendChild(romaji);
  card.appendChild(link);
  card.appendChild(native);

  return card;
}

function render(mangaData) {
  container.innerHTML = '';
  const years = Object.keys(mangaData).sort((a, b) => b - a);
  totalMangaCount = 0;

  for (const year of years) {
    const mangas = mangaData[year];
    if (!mangas || mangas.length === 0) continue;

    totalMangaCount += mangas.length;

    const yearGroup = document.createElement('div');
    yearGroup.className = 'year-group';

    const yearTitle = document.createElement('div');
    yearTitle.className = 'year-title';
    yearTitle.textContent = year;

    const grid = document.createElement('div');
    grid.className = 'grid';

    mangas.forEach(manga => {
      const card = createMangaCard(manga);
      grid.appendChild(card);
    });

    yearGroup.appendChild(yearTitle);
    yearGroup.appendChild(grid);
    container.appendChild(yearGroup);
  }
  updateCounter();
}
  
titleSwitch.addEventListener('change', () => {
  const hideJapanese = titleSwitch.checked;
  document.querySelectorAll('.title-native').forEach(el => {
    el.style.display = hideJapanese ? 'none' : 'block';
  });
});

// Initialize with Japanese titles visible
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.title-native').forEach(el => {
    el.style.display = 'block';
  });
});

downloadBtn.addEventListener('click', () => {
  container.style.pointerEvents = 'none';
  html2canvas(container, {
    scale: 2,
    scrollY: -window.scrollY,
    scrollX: -window.scrollX,
    useCORS: true,
    allowTaint: false
  }).then(canvas => {
    container.style.pointerEvents = '';
    canvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'yuri_manga_results.png';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
  }).catch(err => {
    container.style.pointerEvents = '';
    alert('Failed to generate image.');
    console.error(err);
  });
});

fetch('./data.json')
  .then(res => res.json())
  .then(data => {
    render(data);
  })
  .catch(err => {
    counterEl.textContent = 'Failed to load data.';
    console.error('Error loading data.json:', err);
  });
</script>

</body>
</html>
